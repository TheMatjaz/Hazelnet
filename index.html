<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hazelnet: Hazelnet library: CAN FD bus encryption, authentication and freshness</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Hazelnet<span id="projectnumber">&#160;3.0.0</span>
   </div>
   <div id="projectbrief">Reference implementation of the CAN Bus Security (CBS) protocol</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Hazelnet library: CAN FD bus encryption, authentication and freshness </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a></p>
<p >Hazelnet implements the Client and Server roles of the <a href="https://matjaz.it/cbs/">CAN Bus Security (CBS) protocol</a>, which secures the CAN FD traffic providing encryption, authenticity, and freshness of the messages.</p>
<p >The user of the library must handle the physical transmission and reception manually as this library only handles the building of messages to transmit and processing of received messages. This is done to guarantee better portability across systems. The internal library state keeps track of ongoing handshakes, timeouts and other events per each Group.</p>
<p >The library uses standard C11 code and is hardware-independent. The compile targets for a desktop OS add some features like heap memory allocation and use the time and TRNG functionality the OS provides. The any-platform version uses user-provided structs to operate on and requires the user to provide function pointers to custom timestamping and random-number-generators of the used platform; recommended for embedded systems.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Dependencies</h1>
<p >Hazelnet depends on other projects from the same author:</p>
<ul>
<li>required: <a href="https://github.com/TheMatjaz/LibAscon">LibAscon</a> crypto library (CC0 license).</li>
<li>for testing only: <a href="https://github.com/TheMatjaz/atto">Atto</a> minimal unit test framework (BSD 3-clause license)</li>
<li>for config generation only: <a href="https://github.com/TheMatjaz/HazelnetConfig">HzlConfig</a> to write the configuration of the entire bus in one JSON file and generate the binary configurations of each Hazelnet instance (CBS Party).</li>
</ul>
<p >The dependencies are included in this project as Git Submodules, so be sure to clone this repository with the <code>--recurse-submodules</code> option.</p>
<p >You only need the C99/C11 standard library to compile the library for any platform, including embedded. No heap-allocation required (malloc).</p>
<ul>
<li><code>stdint.h</code></li>
<li><code>stdbool.h</code></li>
<li><code>stddef.h</code></li>
<li><code>string.h</code></li>
</ul>
<p >On the other hand, when compiling for a desktop OS, additional features are enabled. In particular configurations can be loaded from files, the library context is heap-allocated, and the OS provides the current time and true randomness.</p>
<ul>
<li><code>stdlib.h</code> for heap-allocation (calloc)</li>
<li><code>stdio.h</code> to access configuration files</li>
<li>On Windows also<ul>
<li><code>sysinfoapi.h</code> to get the current time in milliseconds</li>
<li><code>bcrypt.h</code> to get random numbers</li>
</ul>
</li>
<li>On Unix-like systems also<ul>
<li><code>sys/time.h</code> to get the current time in milliseconds</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Known limitations</h1>
<p >The library is <b>not thread safe</b>. All API calls on the same context should be performed within the same thread (or RTOS task) or mutual exclusion locks should be placed by the library user around said API calls to protect the library from race conditions. For the time being, no thread-safe protections have been implemented as they are not easily portable.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Project structure</h1>
<ul>
<li>The <code>inc</code> folder contains the public headers of the library.<ul>
<li><code><a class="el" href="hzl_8h.html" title="General public definitions used used by both the Hazelnet Server and Client.">hzl.h</a></code> is a common header for both the Client and Server. You always need this.</li>
<li><code><a class="el" href="hzl___client_8h.html" title="Hazelnet Client public API.">hzl_Client.h</a></code> and <code><a class="el" href="hzl___server_8h.html" title="Hazelnet Server public API.">hzl_Server.h</a></code> are the API header of the Client and Server libraries (respectively) when compiled for any platform. Pick one of the two roles.</li>
<li><code><a class="el" href="hzl___client_os_8h.html" title="Hazelnet Client public API, addon for Operating Systems.">hzl_ClientOs.h</a></code> and <code><a class="el" href="hzl___server_os_8h.html" title="Hazelnet Server public API, addon for Operating Systems.">hzl_ServerOs.h</a></code> are extensions of the API for the Client and Server libraries (respectively) when compiled for desktop operating systems (assuming a file system and heap-memory allocation).</li>
</ul>
</li>
<li>The <code>src</code> folder contains the library sources:<ul>
<li><code>src/common</code> is code shared between Client and Server</li>
<li><code>src/client</code> and <code>src/server</code> folder contain sources for the respective Parties</li>
<li>The <code>.c</code> files are generally named after the user-facing API function they implement.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Example usage of the Client library API</h1>
<p >To use the client library, the following headers are required:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl_8h.html">hzl.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl___client_8h.html">hzl_Client.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl___client_os_8h.html">hzl_ClientOs.h</a>&quot;</span> <span class="comment">/* Optional, for a desktop OS only. */</span></div>
<div class="ttc" id="ahzl_8h_html"><div class="ttname"><a href="hzl_8h.html">hzl.h</a></div><div class="ttdoc">General public definitions used used by both the Hazelnet Server and Client.</div></div>
<div class="ttc" id="ahzl___client_8h_html"><div class="ttname"><a href="hzl___client_8h.html">hzl_Client.h</a></div><div class="ttdoc">Hazelnet Client public API.</div></div>
<div class="ttc" id="ahzl___client_os_8h_html"><div class="ttname"><a href="hzl___client_os_8h.html">hzl_ClientOs.h</a></div><div class="ttdoc">Hazelnet Client public API, addon for Operating Systems.</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
On a desktop OS</h3>
<div class="fragment"><div class="line"><span class="comment">// Load the configuration from a binary file, use the OS for the current time</span></div>
<div class="line"><span class="comment">// and random number generation. A Python package is available in the</span></div>
<div class="line"><span class="comment">// `external/hazelnetconfig` project to generate the config files from a JSON</span></div>
<div class="line"><span class="comment">// file.</span></div>
<div class="line"><a class="code hl_typedef" href="hzl_8h.html#a992c5466a30f9bf40204cfc5bd8a8bec">hzl_Err_t</a> err;</div>
<div class="line"><a class="code hl_struct" href="structhzl___client_ctx.html">hzl_ClientCtx</a>* pCtx;</div>
<div class="line">err = <a class="code hl_function" href="hzl___client_os_8h.html#abf71451df25f2969929ce4dfe13b5040">hzl_ClientNew</a>(&amp;pCtx, <span class="stringliteral">&quot;myconfigfile.hzl&quot;</span>);</div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line"><a class="code hl_struct" href="structhzl___cbs_pdu_msg.html">hzl_CbsPduMsg_t</a>* pPdu; <span class="comment">// Packed data, fits into one CAN FD message</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Let&#39;s allocate the memory for a message we want to send</span></div>
<div class="line">err = <a class="code hl_function" href="hzl___client_os_8h.html#a9de5315b1b4d65979c53b3cc8de55beb">hzl_ClientNewMsg</a>(&amp;pPdu);</div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// To start secured communication within a Group, we need to start a handshake</span></div>
<div class="line"><a class="code hl_typedef" href="hzl_8h.html#a5141d0db3abd7f536c3e4c428b51a273">hzl_Gid_t</a> destinationGroupId = 2; <span class="comment">// The set of nodes we want to talk to</span></div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#a5cc4e487a90d8bfd51163decf987e12a">hzl_ClientBuildRequest</a>(pPdu, ctx, destinationGroupId);</div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line"><span class="comment">// The Request message is built, the user must transmit it manually</span></div>
<div class="line">myCustomTransmission(pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a3d2666b1278ef28c1444e02a02c03bb3">data</a>, pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">dataLen</a>);</div>
<div class="line"><span class="comment">// The library takes care of storing the building timestamp, the current status</span></div>
<div class="line"><span class="comment">// and timeout checks. The user must only take care of transmission and</span></div>
<div class="line"><span class="comment">// reception.</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// After some time, the Server will transmit a Response. To process received</span></div>
<div class="line"><span class="comment">// messages (often in a separate thread/task), do as follows:</span></div>
<div class="line"><a class="code hl_struct" href="structhzl___rx_msg.html">hzl_RxSduMsg_t</a> userData;</div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#a7d4a895b6dd79d5f44e6a8d30a8259ed">hzl_ClientProcessReceived</a>(</div>
<div class="line">    pPdu,                  <span class="comment">// automatic internal reaction message, if required</span></div>
<div class="line">    &amp;userData,             <span class="comment">// decrypted user-data, if the message had any</span></div>
<div class="line">    pCtx,</div>
<div class="line">    receivedPackedData,    <span class="comment">// the CAN FD payload as received from the layer below</span></div>
<div class="line">    receivedPackedDataLen, <span class="comment">// the CAN FD payload length in bytes (CAN DLC)</span></div>
<div class="line">    receivedCanId          <span class="comment">// the CAN ID of the message had</span></div>
<div class="line">);</div>
<div class="line"><span class="comment">// The error codes are many, including the cases when the message is simply</span></div>
<div class="line"><span class="comment">// ignored or when it contains critical security errors. Be sure to check them!</span></div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line"><span class="comment">// Transmit an automatic reaction message</span></div>
<div class="line"><span class="keywordflow">if</span> (pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">dataLen</a> &gt; 0) { myCustomTransmission(pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a3d2666b1278ef28c1444e02a02c03bb3">data</a>, pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">dataLen</a>); }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// If the Response from the Server was received, we can now build a secured</span></div>
<div class="line"><span class="comment">// data message for the Group that had the handshake completed.</span></div>
<div class="line">uint8_t secretMessage[] = <span class="stringliteral">&quot;hello world&quot;</span>;</div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#ad99b57dd6a62fda5348fbfdf95370029">hzl_ClientBuildSecuredFd</a>(pPdu,</div>
<div class="line">                               pCtx,</div>
<div class="line">                               secretMessage,</div>
<div class="line">                               <span class="keyword">sizeof</span>(secretMessage),</div>
<div class="line">                               destinationGroupId);</div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line">myCustomTransmission(pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a3d2666b1278ef28c1444e02a02c03bb3">data</a>, pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">dataLen</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// At any point in time, unsecured messages may be sent, even for Groups</span></div>
<div class="line"><span class="comment">// that don&#39;t have a handshake completed or are not in the configuration.</span></div>
<div class="line"><span class="comment">// USE IT ONLY FOR ALREADY SECURED or NON SENSITIVE DATA.</span></div>
<div class="line">uint8_t publicMessage[] = <span class="stringliteral">&quot;just some debug info&quot;</span>;</div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#ad99b57dd6a62fda5348fbfdf95370029">hzl_ClientBuildSecuredFd</a>(pPdu,</div>
<div class="line">                               pCtx,</div>
<div class="line">                               publicMessage,</div>
<div class="line">                               <span class="keyword">sizeof</span>(publicMessage),</div>
<div class="line">                               0);  <span class="comment">// Group 0 is a broadcast</span></div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line">myCustomTransmission(pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a3d2666b1278ef28c1444e02a02c03bb3">data</a>, pPdu-&gt;<a class="code hl_variable" href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">dataLen</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Free the heap memory when done</span></div>
<div class="line"><a class="code hl_function" href="hzl___client_os_8h.html#ae2be037a6fd82c7145363e4d358395b0">hzl_ClientFree</a>(&amp;pCtx);</div>
<div class="line"><a class="code hl_function" href="hzl___client_os_8h.html#abeda12133ba9859df8000e3bae51c5db">hzl_ClientFreeMsg</a>(&amp;pPdu);</div>
<div class="ttc" id="ahzl_8h_html_a5141d0db3abd7f536c3e4c428b51a273"><div class="ttname"><a href="hzl_8h.html#a5141d0db3abd7f536c3e4c428b51a273">hzl_Gid_t</a></div><div class="ttdeci">uint8_t hzl_Gid_t</div><div class="ttdoc">Group Identifier data type.</div><div class="ttdef"><b>Definition:</b> hzl.h:462</div></div>
<div class="ttc" id="ahzl_8h_html_a992c5466a30f9bf40204cfc5bd8a8bec"><div class="ttname"><a href="hzl_8h.html#a992c5466a30f9bf40204cfc5bd8a8bec">hzl_Err_t</a></div><div class="ttdeci">enum hzl_Err hzl_Err_t</div><div class="ttdoc">Hazelnet error code, returned by all API functions.</div></div>
<div class="ttc" id="ahzl_8h_html_a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b"><div class="ttname"><a href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a></div><div class="ttdeci">@ HZL_OK</div><div class="ttdoc">Successful completion of the operation.</div><div class="ttdef"><b>Definition:</b> hzl.h:171</div></div>
<div class="ttc" id="ahzl___client_8h_html_a5cc4e487a90d8bfd51163decf987e12a"><div class="ttname"><a href="hzl___client_8h.html#a5cc4e487a90d8bfd51163decf987e12a">hzl_ClientBuildRequest</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientBuildRequest(hzl_CbsPduMsg_t *requestPdu, hzl_ClientCtx_t *ctx, hzl_Gid_t groupId)</div><div class="ttdoc">Builds a Request message, asking for the Session information for a specific group,...</div></div>
<div class="ttc" id="ahzl___client_8h_html_a7d4a895b6dd79d5f44e6a8d30a8259ed"><div class="ttname"><a href="hzl___client_8h.html#a7d4a895b6dd79d5f44e6a8d30a8259ed">hzl_ClientProcessReceived</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientProcessReceived(hzl_CbsPduMsg_t *reactionPdu, hzl_RxSduMsg_t *receivedUserData, hzl_ClientCtx_t *ctx, const uint8_t *receivedPdu, size_t receivedPduLen, hzl_CanId_t receivedCanId)</div><div class="ttdoc">Validates, unpacks and decrypts (if necessary) any received message, preparing an automatic response ...</div></div>
<div class="ttc" id="ahzl___client_8h_html_ad99b57dd6a62fda5348fbfdf95370029"><div class="ttname"><a href="hzl___client_8h.html#ad99b57dd6a62fda5348fbfdf95370029">hzl_ClientBuildSecuredFd</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientBuildSecuredFd(hzl_CbsPduMsg_t *securedPdu, hzl_ClientCtx_t *ctx, const uint8_t *userData, size_t userDataLen, hzl_Gid_t groupId)</div><div class="ttdoc">Builds a secured message, encrypted, authenticated and timely, only for the given group to be able to...</div></div>
<div class="ttc" id="ahzl___client_os_8h_html_a9de5315b1b4d65979c53b3cc8de55beb"><div class="ttname"><a href="hzl___client_os_8h.html#a9de5315b1b4d65979c53b3cc8de55beb">hzl_ClientNewMsg</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientNewMsg(hzl_CbsPduMsg_t **pMsg)</div><div class="ttdoc">Allocates a new CAN FD message structure on the heap with enough space to hold up to 64 B of data.</div></div>
<div class="ttc" id="ahzl___client_os_8h_html_abeda12133ba9859df8000e3bae51c5db"><div class="ttname"><a href="hzl___client_os_8h.html#abeda12133ba9859df8000e3bae51c5db">hzl_ClientFreeMsg</a></div><div class="ttdeci">HZL_API void hzl_ClientFreeMsg(hzl_CbsPduMsg_t **pMsg)</div><div class="ttdoc">Zeros-out the message, frees it and sets the pointer to it to NULL, to avoid use-after-free and doubl...</div></div>
<div class="ttc" id="ahzl___client_os_8h_html_abf71451df25f2969929ce4dfe13b5040"><div class="ttname"><a href="hzl___client_os_8h.html#abf71451df25f2969929ce4dfe13b5040">hzl_ClientNew</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientNew(hzl_ClientCtx_t **pCtx, const char *fileName)</div><div class="ttdoc">Allocates a new context structure on the heap and fills it with the new configuration from the file a...</div></div>
<div class="ttc" id="ahzl___client_os_8h_html_ae2be037a6fd82c7145363e4d358395b0"><div class="ttname"><a href="hzl___client_os_8h.html#ae2be037a6fd82c7145363e4d358395b0">hzl_ClientFree</a></div><div class="ttdeci">HZL_API void hzl_ClientFree(hzl_ClientCtx_t **pCtx)</div><div class="ttdoc">Zeros-out the context, frees it and sets the pointer to it to NULL, to avoid use-after-free and doubl...</div></div>
<div class="ttc" id="astructhzl___cbs_pdu_msg_html"><div class="ttname"><a href="structhzl___cbs_pdu_msg.html">hzl_CbsPduMsg</a></div><div class="ttdoc">Packed CBS PDU (Protocol Data Unit message) ready to be transmitted by the library user.</div><div class="ttdef"><b>Definition:</b> hzl.h:512</div></div>
<div class="ttc" id="astructhzl___cbs_pdu_msg_html_a130324203ba2e5065fcbb4bdc55bc81d"><div class="ttname"><a href="structhzl___cbs_pdu_msg.html#a130324203ba2e5065fcbb4bdc55bc81d">hzl_CbsPduMsg::dataLen</a></div><div class="ttdeci">size_t dataLen</div><div class="ttdoc">Length in bytes of the CBS-Payload.</div><div class="ttdef"><b>Definition:</b> hzl.h:513</div></div>
<div class="ttc" id="astructhzl___cbs_pdu_msg_html_a3d2666b1278ef28c1444e02a02c03bb3"><div class="ttname"><a href="structhzl___cbs_pdu_msg.html#a3d2666b1278ef28c1444e02a02c03bb3">hzl_CbsPduMsg::data</a></div><div class="ttdeci">uint8_t data[HZL_MAX_CAN_FD_DATA_LEN]</div><div class="ttdoc">CBS-Payload.</div><div class="ttdef"><b>Definition:</b> hzl.h:514</div></div>
<div class="ttc" id="astructhzl___client_ctx_html"><div class="ttname"><a href="structhzl___client_ctx.html">hzl_ClientCtx</a></div><div class="ttdoc">Configuration and status of the HazelNet Client library.</div><div class="ttdef"><b>Definition:</b> hzl_Client.h:221</div></div>
<div class="ttc" id="astructhzl___rx_msg_html"><div class="ttname"><a href="structhzl___rx_msg.html">hzl_RxMsg</a></div><div class="ttdoc">Unpacked received SDU (Service Data Unit message) after validation (and optional decryption).</div><div class="ttdef"><b>Definition:</b> hzl.h:519</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
On an embedded system</h3>
<p >The usage is the same except compared to the desktop OS case, except for the Context init and deinit as it cannot necessarily happen on the heap or be loaded from a file. The user must prepare it manually:</p>
<div class="fragment"><div class="line"><span class="comment">// Prepare the Context manually.</span></div>
<div class="line"><a class="code hl_typedef" href="hzl_8h.html#a992c5466a30f9bf40204cfc5bd8a8bec">hzl_Err_t</a> err;</div>
<div class="line">hazelnetGroupStates[10]; <span class="comment">// Assuming 10 groups. No need to initialise!</span></div>
<div class="line"><a class="code hl_struct" href="structhzl___client_ctx.html">hzl_ClientCtx</a> ctx = {</div>
<div class="line">    <span class="comment">// Add the pointers to the constant configuration structs (which are NEVER</span></div>
<div class="line">    <span class="comment">// written to by the library). E.g. a pointer to the prepared data in the</span></div>
<div class="line">    <span class="comment">// persistent flash memory. STRUCTS MUST INCLUDE ANY PADDINGS!</span></div>
<div class="line">    .<a class="code hl_variable" href="structhzl___client_ctx.html#aac19c6aece6e57b65d89c6a4a2b71228">clientConfig</a> = MY_ADDR_OF_THE_HAZELNET_CONFIG_OF_THIS_CLIENT,</div>
<div class="line">    .groupConfigs = MY_ADDR_OF_THE_HAZELNET_GROUP_CONFIGS_OF_THIS_CLIENT,</div>
<div class="line">    <span class="comment">// and the memory used for the group states, which is initialised</span></div>
<div class="line">    <span class="comment">// and manager by the library.</span></div>
<div class="line">    .groupStates = hazelnetGroupStates,</div>
<div class="line">    <span class="comment">// Finally the timestamping and random number generation functions</span></div>
<div class="line">    <span class="comment">// provided as function pointers.</span></div>
<div class="line">    .io = {</div>
<div class="line">        .trng = &amp;myPlatformTrueRandomNumberGeneratorWrappedForHazelnet,</div>
<div class="line">        .currentTime = &amp;myPlatformCurrentTimeFuncWrappedForHazelnet</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"><span class="comment">// The init function will run many checks verifying if the configuration is OK.</span></div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#a8871f5c25863990dd7103848732338b0">hzl_ClientInit</a>(&amp;ctx); <span class="comment">// Instead of ClientNew()</span></div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// -----------</span></div>
<div class="line"><span class="comment">// Use the other library functions as in the Desktop OS example above.</span></div>
<div class="line"><span class="comment">// -----------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// When done or before entering sleep-mode/low-power-mode, deinit the context</span></div>
<div class="line"><span class="comment">// to erase security-critical information.</span></div>
<div class="line">err = <a class="code hl_function" href="hzl___client_8h.html#a869f863b4690ec8b03c1256d67237644">hzl_ClientDeInit</a>(&amp;ctx); <span class="comment">// Instead of ClientFree()</span></div>
<div class="line"><span class="keywordflow">if</span> (err != <a class="code hl_enumvalue" href="hzl_8h.html#a9e46f00210350b247e5ec159e29ec11da987be958f061493a9aa216995fd2556b">HZL_OK</a>) { custom_error_handling(err); }</div>
<div class="ttc" id="ahzl___client_8h_html_a869f863b4690ec8b03c1256d67237644"><div class="ttname"><a href="hzl___client_8h.html#a869f863b4690ec8b03c1256d67237644">hzl_ClientDeInit</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientDeInit(hzl_ClientCtx_t *ctx)</div><div class="ttdoc">Deinitialisation of the Client, securely clearing the state.</div></div>
<div class="ttc" id="ahzl___client_8h_html_a8871f5c25863990dd7103848732338b0"><div class="ttname"><a href="hzl___client_8h.html#a8871f5c25863990dd7103848732338b0">hzl_ClientInit</a></div><div class="ttdeci">HZL_API hzl_Err_t hzl_ClientInit(hzl_ClientCtx_t *ctx)</div><div class="ttdoc">Initialisation of the Client.</div></div>
<div class="ttc" id="astructhzl___client_ctx_html_aac19c6aece6e57b65d89c6a4a2b71228"><div class="ttname"><a href="structhzl___client_ctx.html#aac19c6aece6e57b65d89c6a4a2b71228">hzl_ClientCtx::clientConfig</a></div><div class="ttdeci">HZL_SET_BY_USER const hzl_ClientConfig_t * clientConfig</div><div class="ttdoc">Pointer to one struct with the constant Client configuration.</div><div class="ttdef"><b>Definition:</b> hzl_Client.h:227</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
Example usage of the Server library API</h1>
<p >The Server library has an analogous API to the Client, with the same interface when it comes to processing of the messages. The main difference is that the Server requires an additional configuration field in its context, namely the array of per-Client configurations.</p>
<p >To use the Server library, the following headers are required:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl_8h.html">hzl.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl___server_8h.html">hzl_Server.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hzl___server_os_8h.html">hzl_ServerOs.h</a>&quot;</span> <span class="comment">/* Optional, for a desktop OS only. */</span></div>
<div class="ttc" id="ahzl___server_8h_html"><div class="ttname"><a href="hzl___server_8h.html">hzl_Server.h</a></div><div class="ttdoc">Hazelnet Server public API.</div></div>
<div class="ttc" id="ahzl___server_os_8h_html"><div class="ttname"><a href="hzl___server_os_8h.html">hzl_ServerOs.h</a></div><div class="ttdoc">Hazelnet Server public API, addon for Operating Systems.</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
Including the library in your project</h1>
<p >There are multiple valid ways of doing so. The project is CMake-enabled, so this should be the easiest way. For embedded systems where CMake is not an option, the project may be also compiled using any custom build system.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Cloning with submodules</h2>
<p >The dependencies are included in this project as Git Submodules, so be sure to clone this repository with the <code>--recurse-submodules</code> option.</p>
<div class="fragment"><div class="line">git clone --recurse-submodules https://github.com/TheMatjaz/Hazelnet</div>
</div><!-- fragment --><p >If you have already cloned the repo, but not the submodules, then run</p>
<div class="fragment"><div class="line">git submodule init</div>
<div class="line">git submodule update</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
Compiling with CMake</h2>
<p >In the project root folder, run the following to create an out-of-source build:</p>
<div class="fragment"><div class="line">mkdir build                   # `build*/` folders are already ignored</div>
<div class="line">cd build</div>
<div class="line">cmake ..                      # Prepare the makefiles, default to MinSizeRel</div>
<div class="line">cmake --build . --parallel    # Equivalent to `make all`</div>
</div><!-- fragment --><p >By default, an optimised-for-size release build is performed. To change it, append the <code>-DCMAKE_BUILD_TYPE=Release</code> or <code>Debug</code> to the <code>cmake ..</code> command and build again.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Compiling with CMake with MSVC</h3>
<p >You may already know this, which makes this section mostly a note for my future self. When compiling from the Windows command line using the MSVC toolchain:</p>
<ul>
<li>You will need <a href="https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-160#developer_command_file_locations">the environment variables</a> to use the MSVC toolchain from the command line<ul>
<li>Hint: search for "x64 Native tools" in the start menu, the first option</li>
<li>Alternative: open the VS tools installer and click on "Launch"</li>
</ul>
</li>
<li>Be sure to select the generator NMake Makefiles when configuring CMake</li>
<li>Use the CMake that comes with MSVC. Mine was installed in <code>"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin\cmake.exe"</code> but yours may be different, especially for different VS versions. This is required if you already installed CMake through MSYS.</li>
</ul>
<div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin\cmake.exe&quot; .. -G &quot;NMake Makefiles&quot;</div>
<div class="line">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\IDE\CommonExtensions\Microsoft\CMake\CMake\bin\cmake.exe&quot; --build .</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md14"></a>
CMake targets explanation</h3>
<ul>
<li><code>hzl_client_any</code>, <code>hzl_server_any</code>: Client- and Server-side static libraries for any platform, including embedded. No assumptions about the system, no heap memory, no files.</li>
<li><code>hzl_client_desktop</code>, <code>hzl_server_desktop</code>: Client- and Server-side static libraries for desktop operating systems, assuming malloc, a file system and using the OS-provided TRNG.</li>
<li><code>hzl_client_desktop_shared</code>, <code>hzl_server_desktop_shared</code>: like <code>hzl_client_desktop</code> and <code>hzl_server_desktop</code> but shared (dynamic) libraries.</li>
</ul>
<p >All other targets are internal dependencies or test targets: the user should not worry about them.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Compiling the library from sources using a custom build system</h2>
<ol type="1">
<li><p class="startli">Include the following directories in the search path for header files (<code>-Iinc</code> compiler option for GCC):</p>
<div class="fragment"><div class="line">inc/</div>
<div class="line">src/common/</div>
<div class="line">src/client/ XOR src/server/ -- THEY ARE MUTUALLY EXCLUSIVE</div>
<div class="line">external/atto/src/</div>
<div class="line">external/libascon/inc</div>
<div class="line">external/libascon/src</div>
</div><!-- fragment --><p class="startli">For the test suite, also add</p>
<div class="fragment"><div class="line">tst/</div>
</div><!-- fragment --></li>
<li><p class="startli">Include the following directories in the search path for source files:</p>
<div class="fragment"><div class="line">src/</div>
<div class="line">external/atto/src/</div>
<div class="line">external/libascon/src/</div>
</div><!-- fragment --><p class="startli">For the test suite, also add</p>
<div class="fragment"><div class="line">tst/</div>
<div class="line">tst/client/ XOR src/server/ XOR tst/interop/ -- THEY ARE MUTUALLY EXCLUSIVE</div>
</div><!-- fragment --></li>
<li>Compile with your favourite toolchain. For the test suite, the <code>tst/(client|server|interop)/hzl(Client|Server|Interop)Test_Main.c</code> file runs all tests, depending which set of tests you are compiling.</li>
</ol>
<h1><a class="anchor" id="autotoc_md16"></a>
Testing the library</h1>
<h2><a class="anchor" id="autotoc_md17"></a>
With CMake (recommended)</h2>
<p >You can run the test suite with <code>ctest</code>:</p>
<div class="fragment"><div class="line">ctest --output-on-failure --parallel</div>
</div><!-- fragment --><p >or by directly executing the test runner executables:</p>
<div class="fragment"><div class="line">test_hzl_client_desktop.exe</div>
<div class="line">test_hzl_client_desktop_shared.exe</div>
<div class="line">test_hzl_server_desktop.exe</div>
<div class="line">test_hzl_server_desktop_shared.exe</div>
<div class="line">test_hzl_interop_desktop.exe</div>
<div class="line">test_hzl_interop_desktop_shared.exe</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
On your embedded system</h2>
<p >To run the unit tests in an embedded environment, rename the <code>main()</code> function of the test runners <code>tst/(client|server)/hzl(Client|Server)Test_Main.c</code> into something else (e.g. <code>runAllHazelnetTests()</code>), integrate it into your embedded firware and call it from your embedded project. The Atto framework assumes you have <code>printf</code> available for the reports, but you can search-and-replace its instances with another function, if you prefer.</p>
<p >The <code>interop</code> tests are meant for desktops only, because it does not make a lot of sense for an embedded device to make an interoperability test with itself.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Doxygen</h1>
<p >Doxygen is build separately (not part of <code>make all</code>) to avoid running it every time the library is recompiled during development:</p>
<div class="fragment"><div class="line">cmake --build . --target hzl_doxygen</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md20"></a>
References</h1>
<ul>
<li><a href="https://matjaz.it/cbs/">CAN Bus Security protocol specification</a>, protocol version: <b>v1.3</b>, document revision: <b>4</b> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
